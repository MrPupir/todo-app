<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ToDo App</title>
    <link rel="icon" type="image/x-icon"
        href="data:image/svg+xml,<svg width=%22100%%22 height=%22100%%22 viewBox=%220 0 24 24%22 fill=%22none%22 xmlns=%22http://www.w3.org/2000/svg%22><path d=%22M22 11.0857V12.0057C21.9988 14.1621 21.3005 16.2604 20.0093 17.9875C18.7182 19.7147 16.9033 20.9782 14.8354 21.5896C12.7674 22.201 10.5573 22.1276 8.53447 21.3803C6.51168 20.633 4.78465 19.2518 3.61096 17.4428C2.43727 15.6338 1.87979 13.4938 2.02168 11.342C2.16356 9.19029 2.99721 7.14205 4.39828 5.5028C5.79935 3.86354 7.69279 2.72111 9.79619 2.24587C11.8996 1.77063 14.1003 1.98806 16.07 2.86572M22 4L12 14.01L9 11.01%22 stroke=%22white%22 stroke-width=%222%22 stroke-linecap=%22round%22 stroke-linejoin=%22round%22/></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>

<body>

    <div id="auth-modal" class="modal-overlay" style="z-index: 999;">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header">
                <h3 style="margin: 0;" id="auth-title">Login</h3>
            </div>
            <div class="modal-body" style="display: flex; flex-direction: column; gap: 16px;">
                <div id="register-fields" style="display: none; flex-direction: column; gap: 16px;">
                    <div style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
                        <img id="reg-avatar-preview" src=""
                            style="width: 60px; height: 60px; border-radius: 50%; background: #27272a; object-fit: cover; display: none;">
                        <button class="btn btn-ghost" onclick="document.getElementById('reg-avatar').click()"
                            style="font-size: 0.8rem;">Upload Avatar (Optional)</button>
                        <input type="file" id="reg-avatar" hidden accept="image/png, image/jpeg, image/gif, image/webp"
                            onchange="previewAvatar(this, 'reg-avatar-preview')">
                    </div>
                    <input type="text" id="reg-displayname" placeholder="Display Name (e.g. John Doe)">
                </div>

                <input type="text" id="auth-username" placeholder="Username (a-z, 0-9)" autocomplete="off">
                <input type="password" id="auth-password" placeholder="Password">

                <div id="register-pass-confirm" style="display: none;">
                    <input type="password" id="auth-confirm" placeholder="Confirm Password">
                </div>

                <button class="btn btn-primary" id="auth-submit" onclick="performAuth()">Login</button>
                <div class="auth-switch" onclick="toggleAuthMode()" id="auth-switch-text">Don't have an account? Sign Up
                </div>
            </div>
        </div>
    </div>

    <div id="settings-modal" class="modal-overlay" onclick="if(event.target===this) closeModal('settings-modal')">
        <div class="modal">
            <div class="modal-header">
                <h3 style="margin: 0;">Profile Settings</h3>
            </div>
            <div class="modal-body" style="display: flex; flex-direction: column; gap: 20px; align-items: center;">
                <div style="position: relative;">
                    <img id="settings-avatar-img" class="settings-avatar-preview" src="">
                    <div id="settings-avatar-initials" class="settings-avatar-preview"
                        style="display:none; background:var(--primary); color:white; font-size:2rem; align-items:center; justify-content:center;">
                    </div>
                </div>
                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-ghost" onclick="document.getElementById('set-avatar-file').click()">Change
                        Avatar</button>
                    <button class="btn btn-danger" onclick="deleteAvatar()">Remove</button>
                </div>
                <input type="file" id="set-avatar-file" hidden accept="image/png, image/jpeg, image/gif, image/webp"
                    onchange="updateAvatar(this)">

                <div style="width: 100%;">
                    <label
                        style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 4px; display: block;">Display
                        Name</label>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" id="settings-displayname">
                        <button class="btn btn-primary" style="padding: 10px 10px;" onclick="updateProfileName()"><svg
                                width="20px" height="20px" viewBox="0 0 24 24" fill="none"
                                xmlns="http://www.w3.org/2000/svg">
                                <path
                                    d="M7 3V6.4C7 6.96005 7 7.24008 7.10899 7.45399C7.20487 7.64215 7.35785 7.79513 7.54601 7.89101C7.75992 8 8.03995 8 8.6 8H15.4C15.9601 8 16.2401 8 16.454 7.89101C16.6422 7.79513 16.7951 7.64215 16.891 7.45399C17 7.24008 17 6.96005 17 6.4V4M17 21V14.6C17 14.0399 17 13.7599 16.891 13.546C16.7951 13.3578 16.6422 13.2049 16.454 13.109C16.2401 13 15.9601 13 15.4 13H8.6C8.03995 13 7.75992 13 7.54601 13.109C7.35785 13.2049 7.20487 13.3578 7.10899 13.546C7 13.7599 7 14.0399 7 14.6V21M21 9.32548V16.2C21 17.8802 21 18.7202 20.673 19.362C20.3854 19.9265 19.9265 20.3854 19.362 20.673C18.7202 21 17.8802 21 16.2 21H7.8C6.11984 21 5.27976 21 4.63803 20.673C4.07354 20.3854 3.6146 19.9265 3.32698 19.362C3 18.7202 3 17.8802 3 16.2V7.8C3 6.11984 3 5.27976 3.32698 4.63803C3.6146 4.07354 4.07354 3.6146 4.63803 3.32698C5.27976 3 6.11984 3 7.8 3H14.6745C15.1637 3 15.4083 3 15.6385 3.05526C15.8425 3.10425 16.0376 3.18506 16.2166 3.29472C16.4184 3.4184 16.5914 3.59135 16.9373 3.93726L20.0627 7.06274C20.4086 7.40865 20.5816 7.5816 20.7053 7.78343C20.8149 7.96237 20.8957 8.15746 20.9447 8.36154C21 8.59171 21 8.8363 21 9.32548Z"
                                    stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" />
                            </svg></button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-ghost" onclick="closeModal('settings-modal')">Close</button>
            </div>
        </div>
    </div>

    <div id="create-modal" class="modal-overlay" onclick="if(event.target===this) closeModal('create-modal')">
        <div class="modal">
            <div class="modal-header">
                <h3 style="margin: 0;">New Task</h3>
            </div>
            <div class="modal-body">
                <textarea id="create-content" rows="3" placeholder="Task description..."></textarea>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 16px;">
                    <div>
                        <label style="font-size: 0.85rem; color: var(--text-muted);">Priority</label>
                        <select id="create-priority">
                            <option value="Low">Low</option>
                            <option value="Normal" selected>Normal</option>
                            <option value="High">High</option>
                            <option value="Critical">Critical</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size: 0.85rem; color: var(--text-muted);">Color</label>
                        <input type="color" id="create-color" value="#27272a" style="height: 42px; padding: 2px;">
                    </div>
                </div>
                <input type="hidden" id="create-column-id">
            </div>
            <div class="modal-footer">
                <button class="btn btn-ghost" onclick="closeModal('create-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="submitCreateTask()">Create</button>
            </div>
        </div>
    </div>

    <div id="members-modal" class="modal-overlay" onclick="if(event.target===this) closeModal('members-modal')">
        <div class="modal">
            <div class="modal-header">
                <h3 style="margin: 0;">Board Members</h3>
            </div>
            <div class="modal-body">
                <div id="invite-section" style="display: flex; gap: 8px; margin-bottom: 16px;">
                    <input type="text" id="invite-username" placeholder="Username to invite">
                    <button class="btn btn-primary" onclick="inviteUser()">Invite</button>
                </div>
                <div id="members-list" style="max-height: 300px; overflow-y: auto;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-ghost" onclick="closeModal('members-modal')">Close</button>
            </div>
        </div>
    </div>

    <div id="edit-modal" class="modal-overlay" onclick="if(event.target===this) closeModal('edit-modal')">
        <div class="modal">
            <div id="edit-modal-content">
                <div class="modal-header">
                    <h3 style="margin: 0;">Task Details</h3>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-danger" id="btn-delete-task" style="padding: 6px 12px;"
                            onclick="askDeleteTask()">Delete</button>
                        <button class="btn-icon" onclick="closeModal('edit-modal')">✕</button>
                    </div>
                </div>
                <div class="edit-layout">
                    <div class="task-properties">
                        <textarea id="edit-content" rows="2"
                            style="margin-bottom: 12px; font-weight: 500; font-size: 1rem;"></textarea>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                            <select id="edit-priority"></select>
                            <input type="color" id="edit-color" style="height: 42px; padding: 2px;">
                        </div>
                        <button class="btn btn-primary" id="btn-save-task" style="width: 100%;"
                            onclick="saveTask()"><svg width="20px" height="20px" viewBox="0 0 24 24" fill="none"
                                xmlns="http://www.w3.org/2000/svg">
                                <path
                                    d="M7 3V6.4C7 6.96005 7 7.24008 7.10899 7.45399C7.20487 7.64215 7.35785 7.79513 7.54601 7.89101C7.75992 8 8.03995 8 8.6 8H15.4C15.9601 8 16.2401 8 16.454 7.89101C16.6422 7.79513 16.7951 7.64215 16.891 7.45399C17 7.24008 17 6.96005 17 6.4V4M17 21V14.6C17 14.0399 17 13.7599 16.891 13.546C16.7951 13.3578 16.6422 13.2049 16.454 13.109C16.2401 13 15.9601 13 15.4 13H8.6C8.03995 13 7.75992 13 7.54601 13.109C7.35785 13.2049 7.20487 13.3578 7.10899 13.546C7 13.7599 7 14.0399 7 14.6V21M21 9.32548V16.2C21 17.8802 21 18.7202 20.673 19.362C20.3854 19.9265 19.9265 20.3854 19.362 20.673C18.7202 21 17.8802 21 16.2 21H7.8C6.11984 21 5.27976 21 4.63803 20.673C4.07354 20.3854 3.6146 19.9265 3.32698 19.362C3 18.7202 3 17.8802 3 16.2V7.8C3 6.11984 3 5.27976 3.32698 4.63803C3.6146 4.07354 4.07354 3.6146 4.63803 3.32698C5.27976 3 6.11984 3 7.8 3H14.6745C15.1637 3 15.4083 3 15.6385 3.05526C15.8425 3.10425 16.0376 3.18506 16.2166 3.29472C16.4184 3.4184 16.5914 3.59135 16.9373 3.93726L20.0627 7.06274C20.4086 7.40865 20.5816 7.5816 20.7053 7.78343C20.8149 7.96237 20.8957 8.15746 20.9447 8.36154C21 8.59171 21 8.8363 21 9.32548Z"
                                    stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" />
                            </svg>Save Changes</button>
                    </div>
                    <div class="comments-container">
                        <div class="comments-list" id="comments-list"></div>
                        <div class="comment-input-area" id="comment-area">
                            <div id="reply-box" style="display:none;" class="reply-preview">
                                <span>Replying to <b id="reply-to-name"></b></span>
                                <button class="btn-icon" style="width:16px; height:16px;"
                                    onclick="cancelReply()">✕</button>
                            </div>
                            <div style="display: flex; gap: 8px; align-items: flex-end;">
                                <button class="btn btn-ghost" style="padding: 10px;"
                                    onclick="document.getElementById('comment-files').click()"><svg width="20px"
                                        height="20px" viewBox="0 0 24 24" fill="none"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <path
                                            d="M17.5 5.25581V16.5C17.5 19.5376 15.0376 22 12 22C8.96243 22 6.5 19.5376 6.5 16.5V5.66667C6.5 3.64162 8.14162 2 10.1667 2C12.1917 2 13.8333 3.64162 13.8333 5.66667V16.4457C13.8333 17.4583 13.0125 18.2791 12 18.2791C10.9875 18.2791 10.1667 17.4583 10.1667 16.4457V6.65116"
                                            stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                            stroke-linejoin="round" />
                                    </svg></button>
                                <textarea id="new-comment" rows="1" placeholder="Type a message..."
                                    style="resize: none; min-height: 42px; max-height: 100px; padding-top: 10px;"></textarea>
                                <button class="btn btn-primary" style="padding: 10px;" onclick="addComment()"><svg
                                        width="20px" height="20px" viewBox="0 0 24 24" fill="none"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <path
                                            d="M10.5004 12H5.00043M4.91577 12.2915L2.58085 19.2662C2.39742 19.8142 2.3057 20.0881 2.37152 20.2569C2.42868 20.4034 2.55144 20.5145 2.70292 20.5567C2.87736 20.6054 3.14083 20.4869 3.66776 20.2497L20.3792 12.7296C20.8936 12.4981 21.1507 12.3824 21.2302 12.2216C21.2993 12.082 21.2993 11.9181 21.2302 11.7784C21.1507 11.6177 20.8936 11.5019 20.3792 11.2705L3.66193 3.74776C3.13659 3.51135 2.87392 3.39315 2.69966 3.44164C2.54832 3.48375 2.42556 3.59454 2.36821 3.74078C2.30216 3.90917 2.3929 4.18255 2.57437 4.72931L4.91642 11.7856C4.94759 11.8795 4.96317 11.9264 4.96933 11.9744C4.97479 12.0171 4.97473 12.0602 4.96916 12.1028C4.96289 12.1508 4.94718 12.1977 4.91577 12.2915Z"
                                            stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                            stroke-linejoin="round" />
                                    </svg></button>
                            </div>
                            <input type="file" id="comment-files" multiple hidden onchange="showFileCount()">
                            <span id="file-count" style="font-size: 0.75rem; color: var(--primary);"></span>
                        </div>
                    </div>
                </div>
                <input type="hidden" id="edit-id">
            </div>
        </div>
    </div>

    <div id="simple-modal" class="modal-overlay" onclick="if(event.target===this) closeModal('simple-modal')">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header">
                <h3 id="simple-title" style="margin: 0;"></h3>
            </div>
            <div class="modal-body">
                <input type="text" id="simple-input">
                <textarea id="simple-textarea" rows="4" style="display:none;"></textarea>
                <p id="simple-msg" style="color: var(--text-muted); display: none;"></p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-ghost" onclick="closeModal('simple-modal')">Cancel</button>
                <button class="btn btn-primary" id="simple-confirm-btn">Confirm</button>
            </div>
        </div>
    </div>

    <div class="history-panel" id="history-panel">
        <div class="modal-header">
            <h3 style="margin: 0;">Activity</h3>
            <button class="btn-icon" onclick="toggleHistory()">✕</button>
        </div>
        <div class="history-list" id="history-list"></div>
    </div>

    <header>
        <div class="logo" onclick="navigateToDashboard()">ToDo App</div>
        <div style="display: flex; align-items: center; gap: 16px;">
            <div id="active-users-list" class="active-users"></div>
            <div id="users-separator"></div>

            <div id="user-display" class="user-profile-header" onclick="openSettingsModal()" style="display: none;">
                <div id="u-avatar-header"></div>
                <span id="u-name" style="font-size: 0.9rem; font-weight: 500;"></span>
            </div>

            <button class="btn-icon" onclick="logout()" title="Logout">
                <svg width="20px" height="20px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M16 17L21 12M21 12L16 7M21 12H9M9 3H7.8C6.11984 3 5.27976 3 4.63803 3.32698C4.07354 3.6146 3.6146 4.07354 3.32698 4.63803C3 5.27976 3 6.11984 3 7.8V16.2C3 17.8802 3 18.7202 3.32698 19.362C3.6146 19.9265 4.07354 20.3854 4.63803 20.673C5.27976 21 6.11984 21 7.8 21H9"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
            </button>
        </div>
    </header>

    <div id="view-dashboard" class="view-section">
        <div
            style="padding: 24px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between;">
            <h2 style="margin: 0;">My Boards</h2>
            <button class="btn btn-primary" onclick="promptCreateBoard()">+ New Board</button>
        </div>
        <div id="boards-grid" class="dashboard-grid"></div>
    </div>

    <div id="view-board" class="view-section">
        <div class="toolbar"
            style="padding: 16px 24px; display: flex; gap: 12px; align-items: center; border-bottom: 1px solid var(--border);">
            <h3 id="board-title" style="margin: 0; margin-right: 16px;"></h3>
            <div id="board-actions" style="display:flex; gap:12px;">
                <button class="btn btn-ghost" onclick="promptColumn()">+ Add Column</button>
                <button class="btn btn-ghost" onclick="openMembersModal()">Members</button>
                <button class="btn btn-danger" onclick="askDeleteBoard()">Delete Board</button>
            </div>
            <div style="flex:1;"></div>
            <button class="btn-icon" onclick="toggleHistory()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <polyline points="12 6 12 12 16 14"></polyline>
                </svg>
            </button>
        </div>
        <div id="board-container"></div>
    </div>

    <div class="toast-container" id="toast-box"></div>

    <div class="lightbox" id="lightbox" onclick="if(event.target===this) this.classList.remove('open')">
        <div id="lb-content"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="app.js"></script>
</body>
</html>