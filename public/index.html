<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ToDo App</title>
    <link rel="icon" type="image/x-icon"
        href="data:image/svg+xml,<svg width=%22100%%22 height=%22100%%22 viewBox=%220 0 24 24%22 fill=%22none%22 xmlns=%22http://www.w3.org/2000/svg%22><path d=%22M22 11.0857V12.0057C21.9988 14.1621 21.3005 16.2604 20.0093 17.9875C18.7182 19.7147 16.9033 20.9782 14.8354 21.5896C12.7674 22.201 10.5573 22.1276 8.53447 21.3803C6.51168 20.633 4.78465 19.2518 3.61096 17.4428C2.43727 15.6338 1.87979 13.4938 2.02168 11.342C2.16356 9.19029 2.99721 7.14205 4.39828 5.5028C5.79935 3.86354 7.69279 2.72111 9.79619 2.24587C11.8996 1.77063 14.1003 1.98806 16.07 2.86572M22 4L12 14.01L9 11.01%22 stroke=%22white%22 stroke-width=%222%22 stroke-linecap=%22round%22 stroke-linejoin=%22round%22/></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-body: #09090b;
            --bg-surface: #18181b;
            --bg-surface-hover: #27272a;
            --bg-modal: #18181b;
            --border: #27272a;
            --primary: #6366f1;
            --primary-hover: #4f46e5;
            --text-main: #f4f4f5;
            --text-muted: #a1a1aa;
            --danger: #ef4444;
            --danger-hover: #dc2626;
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --priority-low: #10b981;
            --priority-normal: #3b82f6;
            --priority-high: #f59e0b;
            --priority-critical: #ef4444;
        }

        * {
            box-sizing: border-box;
            outline: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #3f3f46;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #52525b;
        }

        button {
            cursor: pointer;
            font-family: inherit;
        }

        .btn {
            border: 1px solid transparent;
            border-radius: 6px;
            padding: 8px 16px;
            font-weight: 500;
            font-size: 0.875rem;
            transition: all 0.2s;
            display: inline-flex !important;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-hover);
        }

        .btn-ghost {
            background: transparent;
            color: var(--text-muted);
            border: 1px solid var(--border);
        }

        .btn-ghost:hover {
            background: var(--bg-surface-hover);
            color: var(--text-main);
            border-color: #52525b;
        }

        .btn-danger {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .btn-danger:hover {
            background: rgba(239, 68, 68, 0.2);
        }

        .btn-icon {
            width: 32px;
            height: 32px;
            padding: 0;
            border-radius: 6px;
            background: transparent;
            color: var(--text-muted);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.2s;
        }

        .btn-icon:hover {
            background: var(--bg-surface-hover);
            color: var(--text-main);
        }

        input,
        textarea,
        select {
            width: 100%;
            background: #27272a;
            border: 1px solid transparent;
            color: var(--text-main);
            padding: 10px 12px;
            border-radius: 6px;
            font-family: inherit;
            font-size: 0.9rem;
            transition: 0.2s;
        }

        input:focus,
        textarea:focus,
        select:focus {
            background: #3f3f46;
            border-color: var(--primary);
        }

        header {
            height: 64px;
            background: var(--bg-surface);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 24px;
            z-index: 10;
        }

        .logo {
            font-weight: 700;
            font-size: 1.25rem;
            color: var(--text-main);
            cursor: pointer;
        }

        .active-users {
            display: flex;
            align-items: center;
            gap: -8px;
            padding: 6px 12px;
            opacity: 1;
            transform: scaleY(1);
            transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out;
        }

        .active-users.is-hiding {
            opacity: 0;
            transform: scaleY(0);
            pointer-events: none;
        }

        #users-separator {
            width: 1px;
            height: 28px;
            background: var(--border);
            display: block;
            opacity: 1;
            transform: scaleY(1);
            transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out;
        }

        .active-users.is-hiding+#users-separator {
            opacity: 0;
            transform: scaleY(0);
            pointer-events: none;
        }

        .active-users:empty+#users-separator {
            opacity: 0;
            transform: scaleY(0);
            pointer-events: none;
        }

        .avatar-small {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            font-size: 0.75rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--bg-surface);
            object-fit: cover;
        }

        .view-section {
            transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out;
            opacity: 0;
            display: none;
            width: 100%;
        }

        .view-section.active {
            opacity: 1;
            display: block;
            animation: fadeIn 0.3s forwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .dashboard-grid {
            padding: 40px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 24px;
            overflow-y: auto;
        }

        .board-card {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .board-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .board-title {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .board-meta {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: auto;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        #board-container {
            flex: 1;
            overflow-x: auto;
            padding: 24px;
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }

        .column {
            background: var(--bg-surface);
            min-width: 300px;
            width: 300px;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            max-height: 100%;
            border: 1px solid var(--border);
        }

        .column-header {
            padding: 16px;
            font-weight: 600;
            font-size: 0.95rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
        }

        .task-list {
            padding: 12px;
            overflow-y: auto;
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .task-list:empty {
            padding: 0;
        }

        .task-list.drag-over {
            background: rgba(99, 102, 241, 0.05);
        }

        .task {
            background: #27272a;
            padding: 12px;
            border-radius: 8px;
            cursor: grab;
            border: 1px solid var(--border);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: all 0.2s;
        }

        .task:hover {
            background: #3f3f46;
            transform: translateY(-2px);
            z-index: 5;
        }

        .task.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }

        .priority-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
            display: inline-block;
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(4px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: 0.2s;
        }

        .modal-overlay.open {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--bg-modal);
            border: 1px solid var(--border);
            border-radius: 16px;
            box-shadow: var(--shadow-xl);
            width: 90%;
            max-width: 500px;
            transform: scale(0.95);
            transition: 0.2s cubic-bezier(0.16, 1, 0.3, 1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            max-height: 90vh;
        }

        .modal-overlay.open .modal {
            transform: scale(1);
        }

        .modal-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
        }

        .modal-footer {
            padding: 16px 20px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            background: var(--bg-surface);
        }

        #edit-modal .modal {
            max-width: 800px;
            height: 85vh;
        }

        #edit-modal-content {
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }

        .edit-layout {
            display: flex;
            flex: 1;
            overflow: hidden;
            flex-direction: column;
        }

        .task-properties {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-body);
            flex-shrink: 0;
        }

        .comments-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: #121214;
        }

        .comments-list {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .comment-input-area {
            flex-shrink: 0;
            padding: 16px;
            background: var(--bg-surface);
            border-top: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .reply-preview {
            background: #27272a;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            border-left: 2px solid var(--primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .reply-indicator {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 4px;
            border-left: 2px solid #3f3f46;
            padding-left: 8px;
            margin-top: 4px;
        }

        .msg-bubble {
            background: #27272a;
            padding: 10px 14px;
            border-radius: 12px;
            font-size: 0.9rem;
            line-height: 1.5;
            color: var(--text-main);
            max-width: 85%;
        }

        .msg-bubble.own {
            background: #4f46e5;
            margin-left: auto;
        }

        .history-panel {
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            width: 320px;
            background: var(--bg-surface);
            border-left: 1px solid var(--border);
            transform: translateX(100%);
            transition: transform 0.3s;
            z-index: 90;
            display: flex;
            flex-direction: column;
        }

        .history-panel.open {
            transform: translateX(0);
        }

        .history-list {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        .h-item {
            padding-bottom: 12px;
            margin-bottom: 12px;
            border-bottom: 1px solid var(--border);
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .toast-container {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 999;
            display: flex;
            flex-direction: column;
            gap: 8px;
            pointer-events: none;
        }

        .toast {
            background: var(--bg-surface);
            color: var(--text-main);
            padding: 12px 16px;
            border-radius: 8px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-xl);
            font-size: 0.9rem;
            animation: slideIn 0.3s;
            pointer-events: all;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .attachment-grid {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            flex-wrap: wrap;
        }

        .att-thumb {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 6px;
            border: 1px solid var(--border);
            cursor: pointer;
        }

        .lightbox {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 300;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .lightbox.open {
            display: flex;
        }

        #lb-content {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 90%;
            height: 90%;
        }

        .lightbox img,
        .lightbox video {
            max-width: 90%;
            max-height: 90%;
            border-radius: 4px;
        }

        .member-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }

        .auth-switch {
            text-align: center;
            margin-top: 10px;
            font-size: 0.85rem;
            color: var(--text-muted);
            cursor: pointer;
        }

        .auth-switch:hover {
            color: var(--primary);
            text-decoration: underline;
        }

        .user-profile-header {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 6px 12px;
            border-radius: 8px;
            transition: 0.2s;
        }

        .user-profile-header:hover {
            background: var(--bg-surface-hover);
        }

        .settings-avatar-preview {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--border);
        }

        .member-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
    </style>
</head>

<body>

    <div id="auth-modal" class="modal-overlay" style="z-index: 999;">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header">
                <h3 style="margin: 0;" id="auth-title">Login</h3>
            </div>
            <div class="modal-body" style="display: flex; flex-direction: column; gap: 16px;">
                <div id="register-fields" style="display: none; flex-direction: column; gap: 16px;">
                    <div style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
                        <img id="reg-avatar-preview" src=""
                            style="width: 60px; height: 60px; border-radius: 50%; background: #27272a; object-fit: cover; display: none;">
                        <button class="btn btn-ghost" onclick="document.getElementById('reg-avatar').click()"
                            style="font-size: 0.8rem;">Upload Avatar (Optional)</button>
                        <input type="file" id="reg-avatar" hidden accept="image/png, image/jpeg, image/gif, image/webp"
                            onchange="previewAvatar(this, 'reg-avatar-preview')">
                    </div>
                    <input type="text" id="reg-displayname" placeholder="Display Name (e.g. John Doe)">
                </div>

                <input type="text" id="auth-username" placeholder="Username (a-z, 0-9)" autocomplete="off">
                <input type="password" id="auth-password" placeholder="Password">

                <div id="register-pass-confirm" style="display: none;">
                    <input type="password" id="auth-confirm" placeholder="Confirm Password">
                </div>

                <button class="btn btn-primary" id="auth-submit" onclick="performAuth()">Login</button>
                <div class="auth-switch" onclick="toggleAuthMode()" id="auth-switch-text">Don't have an account? Sign Up
                </div>
            </div>
        </div>
    </div>

    <div id="settings-modal" class="modal-overlay" onclick="if(event.target===this) closeModal('settings-modal')">
        <div class="modal">
            <div class="modal-header">
                <h3 style="margin: 0;">Profile Settings</h3>
            </div>
            <div class="modal-body" style="display: flex; flex-direction: column; gap: 20px; align-items: center;">
                <div style="position: relative;">
                    <img id="settings-avatar-img" class="settings-avatar-preview" src="">
                    <div id="settings-avatar-initials" class="settings-avatar-preview"
                        style="display:none; background:var(--primary); color:white; font-size:2rem; align-items:center; justify-content:center;">
                    </div>
                </div>
                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-ghost" onclick="document.getElementById('set-avatar-file').click()">Change
                        Avatar</button>
                    <button class="btn btn-danger" onclick="deleteAvatar()">Remove</button>
                </div>
                <input type="file" id="set-avatar-file" hidden accept="image/png, image/jpeg, image/gif, image/webp"
                    onchange="updateAvatar(this)">

                <div style="width: 100%;">
                    <label
                        style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 4px; display: block;">Display
                        Name</label>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" id="settings-displayname">
                        <button class="btn btn-primary" style="padding: 10px 10px;" onclick="updateProfileName()"><svg
                                width="20px" height="20px" viewBox="0 0 24 24" fill="none"
                                xmlns="http://www.w3.org/2000/svg">
                                <path
                                    d="M7 3V6.4C7 6.96005 7 7.24008 7.10899 7.45399C7.20487 7.64215 7.35785 7.79513 7.54601 7.89101C7.75992 8 8.03995 8 8.6 8H15.4C15.9601 8 16.2401 8 16.454 7.89101C16.6422 7.79513 16.7951 7.64215 16.891 7.45399C17 7.24008 17 6.96005 17 6.4V4M17 21V14.6C17 14.0399 17 13.7599 16.891 13.546C16.7951 13.3578 16.6422 13.2049 16.454 13.109C16.2401 13 15.9601 13 15.4 13H8.6C8.03995 13 7.75992 13 7.54601 13.109C7.35785 13.2049 7.20487 13.3578 7.10899 13.546C7 13.7599 7 14.0399 7 14.6V21M21 9.32548V16.2C21 17.8802 21 18.7202 20.673 19.362C20.3854 19.9265 19.9265 20.3854 19.362 20.673C18.7202 21 17.8802 21 16.2 21H7.8C6.11984 21 5.27976 21 4.63803 20.673C4.07354 20.3854 3.6146 19.9265 3.32698 19.362C3 18.7202 3 17.8802 3 16.2V7.8C3 6.11984 3 5.27976 3.32698 4.63803C3.6146 4.07354 4.07354 3.6146 4.63803 3.32698C5.27976 3 6.11984 3 7.8 3H14.6745C15.1637 3 15.4083 3 15.6385 3.05526C15.8425 3.10425 16.0376 3.18506 16.2166 3.29472C16.4184 3.4184 16.5914 3.59135 16.9373 3.93726L20.0627 7.06274C20.4086 7.40865 20.5816 7.5816 20.7053 7.78343C20.8149 7.96237 20.8957 8.15746 20.9447 8.36154C21 8.59171 21 8.8363 21 9.32548Z"
                                    stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" />
                            </svg></button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-ghost" onclick="closeModal('settings-modal')">Close</button>
            </div>
        </div>
    </div>

    <div id="create-modal" class="modal-overlay" onclick="if(event.target===this) closeModal('create-modal')">
        <div class="modal">
            <div class="modal-header">
                <h3 style="margin: 0;">New Task</h3>
            </div>
            <div class="modal-body">
                <textarea id="create-content" rows="3" placeholder="Task description..."></textarea>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 16px;">
                    <div>
                        <label style="font-size: 0.85rem; color: var(--text-muted);">Priority</label>
                        <select id="create-priority">
                            <option value="Low">Low</option>
                            <option value="Normal" selected>Normal</option>
                            <option value="High">High</option>
                            <option value="Critical">Critical</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size: 0.85rem; color: var(--text-muted);">Color</label>
                        <input type="color" id="create-color" value="#27272a" style="height: 42px; padding: 2px;">
                    </div>
                </div>
                <input type="hidden" id="create-column-id">
            </div>
            <div class="modal-footer">
                <button class="btn btn-ghost" onclick="closeModal('create-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="submitCreateTask()">Create</button>
            </div>
        </div>
    </div>

    <div id="members-modal" class="modal-overlay" onclick="if(event.target===this) closeModal('members-modal')">
        <div class="modal">
            <div class="modal-header">
                <h3 style="margin: 0;">Board Members</h3>
            </div>
            <div class="modal-body">
                <div id="invite-section" style="display: flex; gap: 8px; margin-bottom: 16px;">
                    <input type="text" id="invite-username" placeholder="Username to invite">
                    <button class="btn btn-primary" onclick="inviteUser()">Invite</button>
                </div>
                <div id="members-list" style="max-height: 300px; overflow-y: auto;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-ghost" onclick="closeModal('members-modal')">Close</button>
            </div>
        </div>
    </div>

    <div id="edit-modal" class="modal-overlay" onclick="if(event.target===this) closeModal('edit-modal')">
        <div class="modal">
            <div id="edit-modal-content">
                <div class="modal-header">
                    <h3 style="margin: 0;">Task Details</h3>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-danger" id="btn-delete-task" style="padding: 6px 12px;"
                            onclick="askDeleteTask()">Delete</button>
                        <button class="btn-icon" onclick="closeModal('edit-modal')">✕</button>
                    </div>
                </div>
                <div class="edit-layout">
                    <div class="task-properties">
                        <textarea id="edit-content" rows="2"
                            style="margin-bottom: 12px; font-weight: 500; font-size: 1rem;"></textarea>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                            <select id="edit-priority"></select>
                            <input type="color" id="edit-color" style="height: 42px; padding: 2px;">
                        </div>
                        <button class="btn btn-primary" id="btn-save-task" style="width: 100%;"
                            onclick="saveTask()"><svg width="20px" height="20px" viewBox="0 0 24 24" fill="none"
                                xmlns="http://www.w3.org/2000/svg">
                                <path
                                    d="M7 3V6.4C7 6.96005 7 7.24008 7.10899 7.45399C7.20487 7.64215 7.35785 7.79513 7.54601 7.89101C7.75992 8 8.03995 8 8.6 8H15.4C15.9601 8 16.2401 8 16.454 7.89101C16.6422 7.79513 16.7951 7.64215 16.891 7.45399C17 7.24008 17 6.96005 17 6.4V4M17 21V14.6C17 14.0399 17 13.7599 16.891 13.546C16.7951 13.3578 16.6422 13.2049 16.454 13.109C16.2401 13 15.9601 13 15.4 13H8.6C8.03995 13 7.75992 13 7.54601 13.109C7.35785 13.2049 7.20487 13.3578 7.10899 13.546C7 13.7599 7 14.0399 7 14.6V21M21 9.32548V16.2C21 17.8802 21 18.7202 20.673 19.362C20.3854 19.9265 19.9265 20.3854 19.362 20.673C18.7202 21 17.8802 21 16.2 21H7.8C6.11984 21 5.27976 21 4.63803 20.673C4.07354 20.3854 3.6146 19.9265 3.32698 19.362C3 18.7202 3 17.8802 3 16.2V7.8C3 6.11984 3 5.27976 3.32698 4.63803C3.6146 4.07354 4.07354 3.6146 4.63803 3.32698C5.27976 3 6.11984 3 7.8 3H14.6745C15.1637 3 15.4083 3 15.6385 3.05526C15.8425 3.10425 16.0376 3.18506 16.2166 3.29472C16.4184 3.4184 16.5914 3.59135 16.9373 3.93726L20.0627 7.06274C20.4086 7.40865 20.5816 7.5816 20.7053 7.78343C20.8149 7.96237 20.8957 8.15746 20.9447 8.36154C21 8.59171 21 8.8363 21 9.32548Z"
                                    stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" />
                            </svg>Save Changes</button>
                    </div>
                    <div class="comments-container">
                        <div class="comments-list" id="comments-list"></div>
                        <div class="comment-input-area" id="comment-area">
                            <div id="reply-box" style="display:none;" class="reply-preview">
                                <span>Replying to <b id="reply-to-name"></b></span>
                                <button class="btn-icon" style="width:16px; height:16px;"
                                    onclick="cancelReply()">✕</button>
                            </div>
                            <div style="display: flex; gap: 8px; align-items: flex-end;">
                                <button class="btn btn-ghost" style="padding: 10px;"
                                    onclick="document.getElementById('comment-files').click()"><svg width="20px"
                                        height="20px" viewBox="0 0 24 24" fill="none"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <path
                                            d="M17.5 5.25581V16.5C17.5 19.5376 15.0376 22 12 22C8.96243 22 6.5 19.5376 6.5 16.5V5.66667C6.5 3.64162 8.14162 2 10.1667 2C12.1917 2 13.8333 3.64162 13.8333 5.66667V16.4457C13.8333 17.4583 13.0125 18.2791 12 18.2791C10.9875 18.2791 10.1667 17.4583 10.1667 16.4457V6.65116"
                                            stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                            stroke-linejoin="round" />
                                    </svg></button>
                                <textarea id="new-comment" rows="1" placeholder="Type a message..."
                                    style="resize: none; min-height: 42px; max-height: 100px; padding-top: 10px;"></textarea>
                                <button class="btn btn-primary" style="padding: 10px;" onclick="addComment()"><svg
                                        width="20px" height="20px" viewBox="0 0 24 24" fill="none"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <path
                                            d="M10.5004 12H5.00043M4.91577 12.2915L2.58085 19.2662C2.39742 19.8142 2.3057 20.0881 2.37152 20.2569C2.42868 20.4034 2.55144 20.5145 2.70292 20.5567C2.87736 20.6054 3.14083 20.4869 3.66776 20.2497L20.3792 12.7296C20.8936 12.4981 21.1507 12.3824 21.2302 12.2216C21.2993 12.082 21.2993 11.9181 21.2302 11.7784C21.1507 11.6177 20.8936 11.5019 20.3792 11.2705L3.66193 3.74776C3.13659 3.51135 2.87392 3.39315 2.69966 3.44164C2.54832 3.48375 2.42556 3.59454 2.36821 3.74078C2.30216 3.90917 2.3929 4.18255 2.57437 4.72931L4.91642 11.7856C4.94759 11.8795 4.96317 11.9264 4.96933 11.9744C4.97479 12.0171 4.97473 12.0602 4.96916 12.1028C4.96289 12.1508 4.94718 12.1977 4.91577 12.2915Z"
                                            stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                            stroke-linejoin="round" />
                                    </svg></button>
                            </div>
                            <input type="file" id="comment-files" multiple hidden onchange="showFileCount()">
                            <span id="file-count" style="font-size: 0.75rem; color: var(--primary);"></span>
                        </div>
                    </div>
                </div>
                <input type="hidden" id="edit-id">
            </div>
        </div>
    </div>

    <div id="simple-modal" class="modal-overlay" onclick="if(event.target===this) closeModal('simple-modal')">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header">
                <h3 id="simple-title" style="margin: 0;"></h3>
            </div>
            <div class="modal-body">
                <input type="text" id="simple-input">
                <textarea id="simple-textarea" rows="4" style="display:none;"></textarea>
                <p id="simple-msg" style="color: var(--text-muted); display: none;"></p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-ghost" onclick="closeModal('simple-modal')">Cancel</button>
                <button class="btn btn-primary" id="simple-confirm-btn">Confirm</button>
            </div>
        </div>
    </div>

    <div class="history-panel" id="history-panel">
        <div class="modal-header">
            <h3 style="margin: 0;">Activity</h3>
            <button class="btn-icon" onclick="toggleHistory()">✕</button>
        </div>
        <div class="history-list" id="history-list"></div>
    </div>

    <header>
        <div class="logo" onclick="navigateToDashboard()">ToDo App</div>
        <div style="display: flex; align-items: center; gap: 16px;">
            <div id="active-users-list" class="active-users"></div>
            <div id="users-separator"></div>

            <div id="user-display" class="user-profile-header" onclick="openSettingsModal()" style="display: none;">
                <div id="u-avatar-header"></div>
                <span id="u-name" style="font-size: 0.9rem; font-weight: 500;"></span>
            </div>

            <button class="btn-icon" onclick="logout()" title="Logout">
                <svg width="20px" height="20px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M16 17L21 12M21 12L16 7M21 12H9M9 3H7.8C6.11984 3 5.27976 3 4.63803 3.32698C4.07354 3.6146 3.6146 4.07354 3.32698 4.63803C3 5.27976 3 6.11984 3 7.8V16.2C3 17.8802 3 18.7202 3.32698 19.362C3.6146 19.9265 4.07354 20.3854 4.63803 20.673C5.27976 21 6.11984 21 7.8 21H9"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
            </button>
        </div>
    </header>

    <div id="view-dashboard" class="view-section">
        <div
            style="padding: 24px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between;">
            <h2 style="margin: 0;">My Boards</h2>
            <button class="btn btn-primary" onclick="promptCreateBoard()">+ New Board</button>
        </div>
        <div id="boards-grid" class="dashboard-grid"></div>
    </div>

    <div id="view-board" class="view-section">
        <div class="toolbar"
            style="padding: 16px 24px; display: flex; gap: 12px; align-items: center; border-bottom: 1px solid var(--border);">
            <h3 id="board-title" style="margin: 0; margin-right: 16px;"></h3>
            <div id="board-actions" style="display:flex; gap:12px;">
                <button class="btn btn-ghost" onclick="promptColumn()">+ Add Column</button>
                <button class="btn btn-ghost" onclick="openMembersModal()">Members</button>
                <button class="btn btn-danger" onclick="askDeleteBoard()">Delete Board</button>
            </div>
            <div style="flex:1;"></div>
            <button class="btn-icon" onclick="toggleHistory()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <polyline points="12 6 12 12 16 14"></polyline>
                </svg>
            </button>
        </div>
        <div id="board-container"></div>
    </div>

    <div class="toast-container" id="toast-box"></div>

    <div class="lightbox" id="lightbox" onclick="if(event.target===this) this.classList.remove('open')">
        <div id="lb-content"></div>
    </div>

    <script>
        let currentUser = null;
        let authToken = null;
        let currentBoardId = null;
        let boardData = { columns: [], tasks: [], history: [], members: [], myRole: 'comment', users: {} };
        let currentOpenTaskId = null;
        let currentReplyTo = null;
        let ws;
        let isRegisterMode = false;

        const escape = (str) => str ? str.replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' })[m]) : '';

        async function api(url, method = 'GET', body = null, isMultipart = false) {
            const headers = {};
            if (authToken) headers['Authorization'] = authToken;
            if (!isMultipart) headers['Content-Type'] = 'application/json';

            const opts = { method, headers };
            if (body) opts.body = isMultipart ? body : JSON.stringify(body);

            const res = await fetch(url, opts);
            if (res.status === 401) {
                if (url.includes('/auth/check')) return { success: false };
                logout();
                return { error: 'Session expired' };
            }
            if (res.status === 403) return { error: 'Access Denied' };
            return res.json();
        }

        function connectWs() {
            const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(protocol + '//' + location.host);
            ws.onopen = () => {
                if (authToken) ws.send(JSON.stringify({ type: 'AUTH', token: authToken }));
                if (currentBoardId) ws.send(JSON.stringify({ type: 'JOIN_BOARD', boardId: currentBoardId }));
            };
            ws.onmessage = (e) => {
                const msg = JSON.parse(e.data);
                if (msg.type === 'UPDATE') {
                    if (msg.deletedTaskId && currentOpenTaskId === msg.deletedTaskId) closeModal('edit-modal');
                    if (currentBoardId) loadBoardData(currentBoardId);
                }
                if (msg.type === 'PRESENCE') updateActiveUsers(msg.users);
                if (msg.type === 'BOARD_ADDED') loadBoards();
                if (msg.type === 'MEMBER_UPDATED') {
                    if (currentBoardId) loadBoardData(currentBoardId);
                }
                if (msg.type === 'KICKED') {
                    if (currentBoardId === msg.boardId) {
                        showToast('You have been removed from this board', 'error');
                        navigateToDashboard();
                    } else loadBoards();
                }
                if (msg.type === 'BOARD_DELETED') {
                    if (currentBoardId === msg.boardId) {
                        showToast('Board deleted', 'error');
                        navigateToDashboard();
                    } else loadBoards();
                }
                if (msg.type === 'AUTH_OK') {
                    console.log('WS authenticated');
                }
            };
            ws.onclose = () => setTimeout(connectWs, 3000);
        }

        window.addEventListener('popstate', handleRouting);
        window.addEventListener('load', () => {
            checkSession();

            const commentInput = document.getElementById('new-comment');
            if (commentInput) {
                commentInput.addEventListener('keydown', function (e) {
                    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); addComment(); }
                });
            }
        });

        connectWs();

        function toggleAuthMode() {
            isRegisterMode = !isRegisterMode;
            document.getElementById('auth-title').innerText = isRegisterMode ? 'Sign Up' : 'Login';
            document.getElementById('auth-submit').innerText = isRegisterMode ? 'Sign Up' : 'Login';
            document.getElementById('auth-switch-text').innerText = isRegisterMode ? 'Already have an account? Login' : 'Don\'t have an account? Sign Up';
            document.getElementById('register-pass-confirm').style.display = isRegisterMode ? 'block' : 'none';
            document.getElementById('register-fields').style.display = isRegisterMode ? 'flex' : 'none';
        }

        function previewAvatar(input, imgId) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = document.getElementById(imgId);
                    img.src = e.target.result;
                    img.style.display = 'block';
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        async function performAuth() {
            const u = document.getElementById('auth-username').value;
            const p = document.getElementById('auth-password').value;

            if (!u || !p) return showToast('Fill all fields', 'error');
            const userRegex = /^[a-zA-Z0-9]+$/;
            if (!userRegex.test(u)) return showToast('Username: only letters and numbers', 'error');

            if (isRegisterMode) {
                const c = document.getElementById('auth-confirm').value;
                const dName = document.getElementById('reg-displayname').value;
                if (p !== c) return showToast('Passwords do not match', 'error');

                const formData = new FormData();
                formData.append('username', u);
                formData.append('password', p);
                formData.append('displayName', dName || u);
                const file = document.getElementById('reg-avatar').files[0];
                if (file) formData.append('avatar', file);

                const res = await api('/api/auth/register', 'POST', formData, true);
                if (res.success) {
                    setSession(res);
                } else showToast(res.error, 'error');
            } else {
                const res = await api('/api/auth/login', 'POST', { username: u, password: p });
                if (res.success) {
                    setSession(res);
                } else showToast(res.error, 'error');
            }
        }

        function setSession(res) {
            authToken = res.token;
            currentUser = res.user;
            localStorage.setItem('authToken', authToken);
            closeModal('auth-modal');
            postLoginInit();
        }

        async function checkSession() {
            authToken = localStorage.getItem('authToken');
            if (!authToken) {
                openModal('auth-modal');
                return;
            }
            const res = await api('/api/auth/check', 'POST', { token: authToken });
            if (res.success) {
                currentUser = { username: res.username, displayName: res.displayName, avatar: res.avatar };
                closeModal('auth-modal');
                postLoginInit();
            } else {
                localStorage.removeItem('authToken');
                authToken = null;
                openModal('auth-modal');
            }
        }

        function postLoginInit() {
            updateUserHeader();
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'AUTH', token: authToken }));
            }
            setTimeout(() => handleRouting(), 50);
        }

        function updateUserHeader() {
            document.getElementById('u-name').innerText = currentUser.displayName;
            document.getElementById('u-avatar-header').innerHTML = renderUserAvatar(currentUser, 30);
            document.getElementById('user-display').style.display = 'flex';
        }

        function openSettingsModal() {
            document.getElementById('settings-displayname').value = currentUser.displayName;
            refreshSettingsAvatar();
            openModal('settings-modal');
        }

        function refreshSettingsAvatar() {
            const img = document.getElementById('settings-avatar-img');
            const ini = document.getElementById('settings-avatar-initials');
            if (currentUser.avatar) {
                img.src = currentUser.avatar;
                img.style.display = 'block';
                ini.style.display = 'none';
            } else {
                img.style.display = 'none';
                ini.style.display = 'flex';
                ini.innerText = currentUser.displayName.substring(0, 2).toUpperCase();
            }
        }

        async function updateAvatar(input) {
            if (input.files && input.files[0]) {
                if (input.files[0].size > 10 * 1024 * 1024) {
                    return showToast('File size must be under 10MB', 'error');
                }
                const formData = new FormData();
                formData.append('avatar', input.files[0]);
                const res = await api('/api/users/avatar', 'PUT', formData, true);
                if (res.success) {
                    currentUser.avatar = res.avatar;
                    refreshSettingsAvatar();
                    updateUserHeader();
                }
            }
        }

        async function deleteAvatar() {
            if (!currentUser.avatar) return;
            const res = await api('/api/users/avatar', 'DELETE');
            if (res.success) {
                currentUser.avatar = null;
                refreshSettingsAvatar();
                updateUserHeader();
            }
        }

        async function updateProfileName() {
            const name = document.getElementById('settings-displayname').value;
            if (!name) return;
            const res = await api('/api/users/profile', 'PUT', { displayName: name });
            if (res.success) {
                currentUser.displayName = name;
                refreshSettingsAvatar();
                updateUserHeader();
                showToast('Profile updated');
            }
        }

        function handleRouting() {
            const path = window.location.pathname;
            if (path === '/' || path === '') {
                loadDashboardView();
            } else {
                const id = path.substring(1);
                if (id) loadBoardView(id);
            }
        }

        function navigateToDashboard() {
            history.pushState({}, '', '/');
            handleRouting();
        }

        function navigateToBoard(id) {
            document.getElementById('view-dashboard').classList.remove('active');
            setTimeout(() => {
                history.pushState({}, '', '/' + id);
                handleRouting();
            }, 10);
        }

        function logout() { localStorage.removeItem('authToken'); location.href = '/'; }

        async function loadDashboardView() {
            if (currentBoardId && ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'LEAVE_BOARD' }));
            }
            currentBoardId = null;

            const activeUsers = document.getElementById('active-users-list');

            activeUsers.classList.add('is-hiding');

            await new Promise(resolve => {
                activeUsers.addEventListener('transitionend', resolve, { once: true });
            });

            activeUsers.innerHTML = '';
            activeUsers.classList.remove('is-hiding');

            document.getElementById('view-board').classList.remove('active');
            document.getElementById('view-dashboard').classList.add('active');
            await loadBoards();
        }

        async function loadBoards() {
            if (!currentUser) {
                console.log('No user logged in');
                return;
            }
            const data = await api(`/api/boards`);
            if (!data || !data.boards) {
                console.log('No boards data');
                return;
            }
            const grid = document.getElementById('boards-grid');
            if (!grid) return;
            grid.innerHTML = data.boards.map(b => `
                <div class="board-card" onclick="navigateToBoard('${b._id}')">
                    <div class="board-title">${escape(b.title)}</div>
                    <div class="board-meta"><svg width="15px" height="15px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 21V19C22 17.1362 20.7252 15.5701 19 15.126M15.5 3.29076C16.9659 3.88415 18 5.32131 18 7C18 8.67869 16.9659 10.1159 15.5 10.7092M17 21C17 19.1362 17 18.2044 16.6955 17.4693C16.2895 16.4892 15.5108 15.7105 14.5307 15.3045C13.7956 15 12.8638 15 11 15H8C6.13623 15 5.20435 15 4.46927 15.3045C3.48915 15.7105 2.71046 16.4892 2.30448 17.4693C2 18.2044 2 19.1362 2 21M13.5 7C13.5 9.20914 11.7091 11 9.5 11C7.29086 11 5.5 9.20914 5.5 7C5.5 4.79086 7.29086 3 9.5 3C11.7091 3 13.5 4.79086 13.5 7Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>${b.members.length + 1} member(-s)</div>
                </div>
            `).join('');
        }

        async function loadBoardView(id) {
            currentBoardId = id;
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'JOIN_BOARD', boardId: id }));
            }

            const res = await loadBoardData(id);
            if (res && res.error) {
                showToast(res.error, 'error');
                navigateToDashboard();
                return;
            }

            document.getElementById('view-board').classList.add('active');
        }

        async function loadBoardData(id) {
            const data = await api(`/api/data?boardId=${id}`);
            if (data.error) return data;
            boardData = data;
            document.getElementById('board-title').innerText = boardData.board.title;

            const canEdit = boardData.myRole === 'edit' || boardData.myRole === 'owner';
            const boardActions = document.getElementById('board-actions');
            boardActions.style.visibility = (canEdit || boardData.myRole === 'owner') ? 'visible' : 'hidden';

            renderBoard();
            renderHistory();
            if (currentOpenTaskId) {
                const task = boardData.tasks.find(t => t._id === currentOpenTaskId);
                if (task) renderComments(task.comments);
                else closeModal('edit-modal');
            }
            return data;
        }

        function renderUserAvatar(user, size = 30) {
            if (!user) return `<div class="avatar-small" style="width:${size}px; height:${size}px">?</div>`;
            if (user.avatar) {
                return `<img src="${user.avatar}" class="avatar-small" style="width:${size}px; height:${size}px; border:none;">`;
            }
            const initials = user.displayName ? user.displayName.substring(0, 2).toUpperCase() : '??';
            return `<div class="avatar-small" style="width:${size}px; height:${size}px">${initials}</div>`;
        }

        function updateActiveUsers(users) {
            const container = document.getElementById('active-users-list');

            container.innerHTML = users.slice(0, 5).map(u => {
                const tooltip = `${escape(u.displayName)} (@${escape(u.username)})`;

                return `<div title="${tooltip}">${renderUserAvatar(u)}</div>`;
            }).join('');

            if (users.length > 5) {
                container.innerHTML += `<div class="avatar-small">+${users.length - 5}</div>`;
            }
        }

        function renderBoard() {
            const container = document.getElementById('board-container');
            container.innerHTML = '';
            const canEdit = boardData.myRole === 'edit' || boardData.myRole === 'owner';

            boardData.columns.forEach(col => {
                const tasks = boardData.tasks.filter(t => t.columnId === col._id).sort((a, b) => a.order - b.order);
                const colEl = document.createElement('div');
                colEl.className = 'column';
                colEl.innerHTML = `
                    <div class="column-header">
                        <span>${escape(col.title)} <span style="color:var(--text-muted); font-weight:400; font-size:0.8em; margin-left:5px;">${tasks.length}</span></span>
                        ${canEdit ? `<button class="btn-icon" style="width:24px; height:24px;" onclick="askDeleteColumn('${col._id}')"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>` : ''}
                    </div>
                    <div class="task-list" ondragover="handleDragOver(event)" ondrop="handleDrop(event, '${col._id}')">${tasks.map(t => renderTaskHTML(t)).join('')}</div>
                    <div style="padding:12px;">
                        ${canEdit ? `<button class="btn btn-ghost" style="width:100%; border-style:dashed;" onclick="createTaskUI('${col._id}')">+ Add Task</button>` : ''}
                    </div>
                `;
                container.appendChild(colEl);
            });
        }

        function renderTaskHTML(task) {
            const hasAtt = task.comments.some(c => c.attachments && c.attachments.length > 0);
            const pColors = { 'Low': 'var(--priority-low)', 'Normal': 'var(--priority-normal)', 'High': 'var(--priority-high)', 'Critical': 'var(--priority-critical)' };
            const canEdit = boardData.myRole === 'edit' || boardData.myRole === 'owner';
            const draggable = canEdit ? 'draggable="true"' : '';
            const authorObj = boardData.users[task.author] || { displayName: task.author };

            return `
                <div class="task" ${draggable} id="${task._id}" style="border-left: 3px solid ${task.color}" ondragstart="handleDragStart(event)" ondragend="handleDragEnd(event)" onclick="openEditTask('${task._id}')">
                    <div style="display:flex; align-items:center; margin-bottom:8px; gap:6px;">
                        <span class="priority-indicator" style="background:${pColors[task.priority]}"></span>
                        <span style="font-size:0.75rem; color:var(--text-muted); font-weight:600;">${task.priority}</span>
                        ${hasAtt ? '<svg width="16px" height="16px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M21.1525 10.8995L12.1369 19.9151C10.0866 21.9653 6.7625 21.9653 4.71225 19.9151C2.662 17.8648 2.662 14.5407 4.71225 12.4904L13.7279 3.47483C15.0947 2.108 17.3108 2.108 18.6776 3.47483C20.0444 4.84167 20.0444 7.05775 18.6776 8.42458L10.0156 17.0866C9.33213 17.7701 8.22409 17.7701 7.54068 17.0866C6.85726 16.4032 6.85726 15.2952 7.54068 14.6118L15.1421 7.01037" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>' : ''}
                    </div>
                    <div style="line-height:1.4; font-size:0.9rem;">${escape(task.content)}</div>
                    <div style="margin-top:10px; font-size:0.75rem; color:var(--text-muted); display:flex; justify-content:space-between; align-items:center;">
                        <div style="display:flex; gap:4px; align-items:center;">💬 ${task.comments.length}</div>
                        <div style="display:flex; align-items:center; gap:6px;">
                           <span style="opacity:0.7">${escape(authorObj.displayName)}</span>
                           ${renderUserAvatar(authorObj, 18)}
                        </div>
                    </div>
                </div>
            `;
        }

        function handleDragStart(e) { e.target.classList.add('dragging'); e.dataTransfer.setData('text', e.target.id); }
        function handleDragEnd(e) { e.target.classList.remove('dragging'); document.querySelectorAll('.task-list').forEach(l => l.classList.remove('drag-over')); }
        function handleDragOver(e) { e.preventDefault(); e.currentTarget.classList.add('drag-over'); }
        async function handleDrop(e, colId) {
            if (boardData.myRole !== 'edit' && boardData.myRole !== 'owner') return;
            e.currentTarget.classList.remove('drag-over');
            const taskId = e.dataTransfer.getData('text');
            const taskEl = document.getElementById(taskId);
            if (!taskEl) return;
            const list = e.currentTarget;
            const afterElement = getDragAfterElement(list, e.clientY);
            if (afterElement) list.insertBefore(taskEl, afterElement); else list.appendChild(taskEl);
            const tasksInCol = [...list.querySelectorAll('.task:not(.dragging)')];
            const newIndex = afterElement ? tasksInCol.indexOf(afterElement) : tasksInCol.length;
            await api('/api/tasks/reorder', 'PUT', { taskId, targetColumnId: colId, newIndex });
        }
        function getDragAfterElement(container, y) {
            const els = [...container.querySelectorAll('.task:not(.dragging)')];
            return els.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) return { offset, element: child }; else return closest;
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        function openModal(id) { document.getElementById(id).classList.add('open'); }
        function closeModal(id) {
            document.getElementById(id).classList.remove('open');
            if (id === 'edit-modal') { currentOpenTaskId = null; cancelReply(); }
        }

        function createTaskUI(colId) {
            document.getElementById('create-column-id').value = colId;
            document.getElementById('create-content').value = '';
            openModal('create-modal');
            setTimeout(() => document.getElementById('create-content').focus(), 100);
        }

        async function submitCreateTask() {
            const content = document.getElementById('create-content').value;
            if (!content.trim()) return;
            const body = {
                content, priority: document.getElementById('create-priority').value,
                color: document.getElementById('create-color').value, columnId: document.getElementById('create-column-id').value,
                boardId: currentBoardId
            };
            await api('/api/tasks/create', 'POST', body);
            closeModal('create-modal');
        }

        function openEditTask(id) {
            currentOpenTaskId = id;
            const task = boardData.tasks.find(t => t._id === id);
            if (!task) return;
            document.getElementById('edit-id').value = id;
            document.getElementById('edit-content').value = task.content;
            document.getElementById('edit-color').value = task.color;
            const sel = document.getElementById('edit-priority');
            sel.innerHTML = ['Low', 'Normal', 'High', 'Critical'].map(p => `<option value="${p}" ${p === task.priority ? 'selected' : ''}>${p}</option>`).join('');

            const canEdit = boardData.myRole === 'edit' || boardData.myRole === 'owner';
            document.getElementById('edit-content').disabled = !canEdit;
            document.getElementById('edit-color').disabled = !canEdit;
            document.getElementById('edit-priority').disabled = !canEdit;
            document.getElementById('btn-save-task').style.display = canEdit ? 'block' : 'none';
            document.getElementById('btn-delete-task').style.display = canEdit ? 'block' : 'none';

            const canComment = boardData.myRole !== 'view';
            document.getElementById('comment-area').style.display = canComment ? 'flex' : 'none';

            renderComments(task.comments);
            openModal('edit-modal');
        }

        async function saveTask() {
            const body = {
                taskId: document.getElementById('edit-id').value,
                content: document.getElementById('edit-content').value,
                priority: document.getElementById('edit-priority').value,
                color: document.getElementById('edit-color').value
            };
            await api('/api/tasks/update', 'PUT', body);
            showToast('Changes saved');
        }

        function startReply(id, author) {
            currentReplyTo = id;
            document.getElementById('reply-box').style.display = 'flex';
            document.getElementById('reply-to-name').innerText = author;
            document.getElementById('new-comment').focus();
        }
        function cancelReply() {
            currentReplyTo = null;
            document.getElementById('reply-box').style.display = 'none';
        }

        function promptEditComment(cid, txt) {
            document.getElementById('simple-title').innerText = 'Edit Comment';
            document.getElementById('simple-input').style.display = 'none';
            document.getElementById('simple-textarea').style.display = 'block';
            document.getElementById('simple-textarea').value = txt;
            document.getElementById('simple-msg').style.display = 'none';
            const btn = document.getElementById('simple-confirm-btn');
            btn.innerText = 'Save';
            btn.className = 'btn btn-primary';
            simpleCb = async () => {
                const newText = document.getElementById('simple-textarea').value;
                const res = await api('/api/comments/edit', 'PUT', { taskId: currentOpenTaskId, commentId: cid, text: newText });
                if (res.success) {
                } else showToast(res.error, 'error');
            };
            openModal('simple-modal');
            setTimeout(() => document.getElementById('simple-textarea').focus(), 100);
        }

        function askDeleteComment(cid) {
            document.getElementById('simple-title').innerText = 'Delete Comment?';
            document.getElementById('simple-input').style.display = 'none';
            document.getElementById('simple-textarea').style.display = 'none';
            document.getElementById('simple-msg').style.display = 'block';
            document.getElementById('simple-msg').innerText = 'Cannot be undone.';
            const btn = document.getElementById('simple-confirm-btn');
            btn.innerText = 'Delete';
            btn.className = 'btn btn-danger';
            simpleCb = () => api('/api/comments/delete', 'DELETE', { taskId: currentOpenTaskId, commentId: cid });
            openModal('simple-modal');
        }

        function renderComments(comments) {
            const list = document.getElementById('comments-list');
            const commentMap = {};
            comments.forEach(c => commentMap[c._id] = c);

            list.innerHTML = comments.map(c => {
                const isOwn = c.author === currentUser.username;
                const authorObj = boardData.users[c.author] || { displayName: c.author };
                let replyBlock = '';
                if (c.replyTo && commentMap[c.replyTo]) {
                    const r = commentMap[c.replyTo];
                    const rAuth = boardData.users[r.author] || { displayName: r.author };
                    replyBlock = `<div class="reply-indicator">Re: <b>${escape(rAuth.displayName)}</b> ${escape(r.text.substring(0, 30))}...</div>`;
                }

                return `
                    <div style="display:flex; flex-direction:column; ${isOwn ? 'align-items:flex-end' : 'align-items:flex-start'}">
                         <div class="comment-meta" style="display:flex; ${isOwn ? 'flex-direction:row-reverse' : ''}; gap:8px; font-size:0.75rem; color:#a1a1aa; align-items:center; margin-bottom:4px;">
                            ${renderUserAvatar(authorObj, 20)}
                            <span style="font-weight:600; color:#f4f4f5;">${escape(authorObj.displayName)}</span>
                            <span>${new Date(c.created).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })} ${c.editedAt ? '(edited)' : ''}</span>
                            <span style="cursor:pointer; color:var(--primary);" onclick="startReply('${c._id}', '${escape(authorObj.displayName)}')"><svg width="16px" height="16px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9 14L4 9M4 9L9 4M4 9H10.4C13.7603 9 15.4405 9 16.7239 9.65396C17.8529 10.2292 18.7708 11.1471 19.346 12.2761C20 13.5595 20 15.2397 20 18.6V20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></span>
                            ${isOwn ? `
                                <span style="cursor:pointer; color:var(--text-muted);" onclick="promptEditComment('${c._id}', '${escape(c.text).replace(/'/g, "\\'")}')"><svg width="16px" height="16px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M18 10L14 6M2.49997 21.5L5.88434 21.124C6.29783 21.078 6.50457 21.055 6.69782 20.9925C6.86926 20.937 7.03242 20.8586 7.18286 20.7594C7.35242 20.6475 7.49951 20.5005 7.7937 20.2063L21 7C22.1046 5.89543 22.1046 4.10457 21 3C19.8954 1.89543 18.1046 1.89543 17 3L3.7937 16.2063C3.49952 16.5005 3.35242 16.6475 3.24061 16.8171C3.1414 16.9676 3.06298 17.1307 3.00748 17.3022C2.94493 17.4954 2.92195 17.7021 2.87601 18.1156L2.49997 21.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></span>
                                <span style="cursor:pointer; color:var(--danger);" onclick="askDeleteComment('${c._id}')"><svg width="16px" height="16px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M16 6V5.2C16 4.0799 16 3.51984 15.782 3.09202C15.5903 2.71569 15.2843 2.40973 14.908 2.21799C14.4802 2 13.9201 2 12.8 2H11.2C10.0799 2 9.51984 2 9.09202 2.21799C8.71569 2.40973 8.40973 2.71569 8.21799 3.09202C8 3.51984 8 4.0799 8 5.2V6M10 11.5V16.5M14 11.5V16.5M3 6H21M19 6V17.2C19 18.8802 19 19.7202 18.673 20.362C18.3854 20.9265 17.9265 21.3854 17.362 21.673C16.7202 22 15.8802 22 14.2 22H9.8C8.11984 22 7.27976 22 6.63803 21.673C6.07354 21.3854 5.6146 20.9265 5.32698 20.362C5 19.7202 5 18.8802 5 17.2V6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></span>
                            ` : ''}
                         </div>
                         <div class="msg-bubble ${isOwn ? 'own' : ''}">
                            ${replyBlock}
                            <div style="white-space: pre-wrap;">${escape(c.text)}</div>
                           ${c.attachments.length ? '<div class="attachment-grid">' +
                        c.attachments
                            .slice()
                            .sort((a, b) => {
                                const priority = { 'image': 1, 'video': 2, 'file': 3 };
                                const typeA = priority[a.type] || 3;
                                const typeB = priority[b.type] || 3;
                                return typeA - typeB;
                            })
                            .map(a => {
                                if (a.type === 'image') return `<img src="${a.url}" class="att-thumb" onclick="viewMedia('${a.url}','img')">`;
                                if (a.type === 'video') return `<video src="${a.url}" class="att-thumb" onclick="viewMedia('${a.url}','vid')"></video>`;
                                return `<a href="${a.url}" target="_blank" style="color:white; display:block; margin-top:4px; font-size:0.8rem;">${escape(a.originalName)}</a>`;
                            }).join('') + '</div>' : ''}
                         </div>
                    </div>
                `;
            }).join('');
            setTimeout(() => list.scrollTop = list.scrollHeight, 0);
        }

        function showFileCount() {
            const n = document.getElementById('comment-files').files.length;
            document.getElementById('file-count').innerText = n ? `${n} attached` : '';
        }

        async function addComment() {
            const text = document.getElementById('new-comment').value;
            const files = document.getElementById('comment-files').files;

            const formData = new FormData();
            formData.append('taskId', document.getElementById('edit-id').value);
            formData.append('text', text);
            if (currentReplyTo) formData.append('replyTo', currentReplyTo);
            for (let f of files) formData.append('files', f);

            const res = await api('/api/tasks/comment', 'POST', formData, true);
            if (res.success) {
                document.getElementById('new-comment').value = '';
                document.getElementById('comment-files').value = '';
                document.getElementById('file-count').innerText = '';
                cancelReply();
            } else showToast(res.error, 'error');
        }

        function openMembersModal() {
            const list = document.getElementById('members-list');
            const isOwner = boardData.myRole === 'owner';
            document.getElementById('invite-section').style.display = isOwner ? 'flex' : 'none';

            const render = () => {
                let html = '';
                boardData.members.forEach(m => {
                    const uObj = boardData.users[m.user] || { displayName: m.user };
                    html += `
                        <div class="member-list-item">
                            <div class="member-info">
                                ${renderUserAvatar(uObj)}
                                <div>
                                    <span style="font-weight:600; color:${m.user === boardData.board.owner ? 'var(--primary)' : 'var(--text-main)'}">${escape(uObj.displayName)}</span>
                                    <div style="font-size:0.75rem; color:var(--text-muted);">@${m.user} ${m.user === boardData.board.owner ? '(Owner)' : ''}</div>
                                </div>
                            </div>
                            <div style="display:flex; align-items:center; gap:8px;">
                                ${isOwner && m.user !== boardData.board.owner ? `
                                    <select style="width:auto; padding:4px;" onchange="changeRole('${m.user}', this.value)">
                                        <option value="view" ${m.role === 'view' ? 'selected' : ''}>View</option>
                                        <option value="comment" ${m.role === 'comment' ? 'selected' : ''}>Comment</option>
                                        <option value="edit" ${m.role === 'edit' ? 'selected' : ''}>Edit</option>
                                    </select>
                                    <button class="btn btn-danger" style="padding:4px 8px; font-size:0.75rem;" onclick="kickMember('${m.user}')">Remove</button>
                                ` : `<span style="font-size:0.8rem; color:var(--text-muted);">${m.role}</span>`}
                            </div>
                        </div>
                    `;
                });
                list.innerHTML = html;
            }
            render();
            openModal('members-modal');
        }

        async function changeRole(username, role) {
            await api('/api/boards/role', 'PUT', { boardId: currentBoardId, username, role });
        }

        async function kickMember(username) {
            await api('/api/boards/member', 'DELETE', { boardId: currentBoardId, username });
        }

        async function inviteUser() {
            const username = document.getElementById('invite-username').value;
            if (!username) return;
            const res = await api('/api/boards/invite', 'POST', { boardId: currentBoardId, username });
            if (res.success) {
                document.getElementById('invite-username').value = '';
                showToast('User invited');
            } else showToast(res.error, 'error');
        }

        let simpleCb = null;
        function promptSimple(title, placeholder, cb) {
            document.getElementById('simple-title').innerText = title;
            document.getElementById('simple-input').placeholder = placeholder;
            document.getElementById('simple-input').style.display = 'block';
            document.getElementById('simple-textarea').style.display = 'none';
            document.getElementById('simple-msg').style.display = 'none';
            document.getElementById('simple-input').value = '';
            const btn = document.getElementById('simple-confirm-btn');
            btn.innerText = 'Confirm';
            btn.className = 'btn btn-primary';
            simpleCb = async () => { if (document.getElementById('simple-input').value) await cb(document.getElementById('simple-input').value); };
            openModal('simple-modal');
            setTimeout(() => document.getElementById('simple-input').focus(), 100);
        }

        function promptCreateBoard() {
            promptSimple('Create Board', 'Board Title', async (title) => {
                const res = await api('/api/boards/create', 'POST', { title });
                if (res.success) loadBoards();
            });
        }

        function promptColumn() {
            promptSimple('New Column', 'Title', async (title) => {
                await api('/api/columns/create', 'POST', { title, boardId: currentBoardId });
            });
        }

        function askDeleteBoard() {
            document.getElementById('simple-title').innerText = 'Delete Board?';
            document.getElementById('simple-input').style.display = 'none';
            document.getElementById('simple-textarea').style.display = 'none';
            document.getElementById('simple-msg').style.display = 'block';
            document.getElementById('simple-msg').innerText = 'All data will be lost.';
            const btn = document.getElementById('simple-confirm-btn');
            btn.innerText = 'Delete';
            btn.className = 'btn btn-danger';
            simpleCb = async () => {
                await api('/api/boards/delete', 'DELETE', { boardId: currentBoardId });
                loadBoards();
                navigateToDashboard();
            };
            openModal('simple-modal');
        }

        function askDeleteColumn(id) {
            document.getElementById('simple-title').innerText = 'Delete Column?';
            document.getElementById('simple-input').style.display = 'none';
            document.getElementById('simple-textarea').style.display = 'none';
            document.getElementById('simple-msg').style.display = 'block';
            document.getElementById('simple-msg').innerText = 'Tasks inside will be lost.';
            const btn = document.getElementById('simple-confirm-btn');
            btn.innerText = 'Delete';
            btn.className = 'btn btn-danger';
            simpleCb = () => api('/api/columns/delete', 'DELETE', { columnId: id, boardId: currentBoardId });
            openModal('simple-modal');
        }

        function askDeleteTask() {
            document.getElementById('simple-title').innerText = 'Delete Task?';
            document.getElementById('simple-input').style.display = 'none';
            document.getElementById('simple-textarea').style.display = 'none';
            document.getElementById('simple-msg').style.display = 'block';
            document.getElementById('simple-msg').innerText = 'Cannot be undone.';
            const btn = document.getElementById('simple-confirm-btn');
            btn.innerText = 'Delete';
            btn.className = 'btn btn-danger';
            simpleCb = async () => {
                await api('/api/tasks/delete', 'DELETE', { taskId: document.getElementById('edit-id').value });
            };
            openModal('simple-modal');
        }

        document.getElementById('simple-confirm-btn').onclick = async () => { if (simpleCb) await simpleCb(); closeModal('simple-modal'); };

        function renderHistory() {
            document.getElementById('history-list').innerHTML = boardData.history.map(h => {
                const uObj = boardData.users[h.user] || { displayName: h.user };
                return `
                <div class="h-item">
                    <span style="color:var(--primary); font-weight:600;">${escape(uObj.displayName)}</span> ${escape(h.text)}
                    <span class="h-time">${new Date(h.date).toLocaleString()}</span>
                </div>
            `}).join('');
        }

        function viewMedia(url, type) {
            const c = document.getElementById('lb-content');
            c.innerHTML = type === 'img' ? `<img src="${url}">` : `<video src="${url}" controls autoplay></video>`;
            document.getElementById('lightbox').classList.add('open');
        }

        function toggleHistory() { document.getElementById('history-panel').classList.toggle('open'); }
        function showToast(msg, type) {
            const t = document.createElement('div');
            t.className = `toast ${type === 'error' ? 'error' : ''}`;
            t.innerText = msg;
            document.getElementById('toast-box').appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }
    </script>
</body>

</html>